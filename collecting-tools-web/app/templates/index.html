<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Collection Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 18px !important;
        }
        
        .sortable::after {
            content: 'â†•';
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
        }
        
        .sortable.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
        }
        
        .sortable.sort-desc::after {
            content: 'â†“';
            opacity: 1;
        }
        
        .pagination {
            justify-content: center;
            margin-top: 1rem;
        }
        
        .table th {
            white-space: nowrap;
        }
        
        /* Fixed column widths */
        #collectionTable {
            table-layout: fixed;
            width: 100%;
        }
        #collectionTable th,
        #collectionTable td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #collectionTable th.status-col { 
            width: auto;
            min-width: 45px;  /* Ensure enough space for the wanted icon (ðŸ”–) */
            padding-right: 20px;  /* Ensure space for sort icon */
        }
        #collectionTable td:first-child {
            text-align: center;
            overflow: visible;  /* Prevent ellipsis in status column */
        }
        #collectionTable th.name-col { width: 32%; }
        #collectionTable th.console-col { width: 15%; }
        #collectionTable th.condition-col { width: 10%; }
        #collectionTable th.price-col { width: 10%; }
        #collectionTable th.change-col { width: 15%; }
        #collectionTable th.date-col { width: 15%; }

        /* Sortable header styles */
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px !important;
        }
        .sortable::after {
            content: 'â‡…';
            position: absolute;
            right: 5px;
            opacity: 0.3;
        }
        .sortable.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
        }
        .sortable.sort-desc::after {
            content: 'â†“';
            opacity: 1;
        }

        /* Ensure table cells don't wrap and show ellipsis */
        #collectionTable td {
            max-width: 0; /* Required for text-overflow to work with table-layout: fixed */
        }
        
        /* Add pointer cursor for cells with tooltips */
        #collectionTable td[title] {
            cursor: help;
        }

        /* Mobile-specific styles */
        @media (max-width: 767px) {
            #collectionTable th.change-col,
            #collectionTable th.date-col,
            #collectionTable td:nth-child(6),
            #collectionTable td:nth-child(7) {
                display: none;
            }

            /* Adjust other column widths for mobile */
            #collectionTable th.name-col { width: 40%; }
            #collectionTable th.console-col { width: 20%; }
            #collectionTable th.condition-col { width: 15%; }
            #collectionTable th.price-col { width: 15%; }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">Game Collection Manager</h1>
        
        <!-- Collection Games -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Collection Games</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" 
                           id="collectionSearch" 
                           class="form-control" 
                           placeholder="Filter games...">
                    <div id="resultCount" class="text-muted mb-2"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="collectionTable">
                        <thead>
                            <tr>
                                <th class="status-col sortable" data-sort="status" aria-label="Status"></th>
                                <th class="name-col sortable" data-sort="name">Name</th>
                                <th class="console-col sortable" data-sort="console">Console</th>
                                <th class="condition-col sortable" data-sort="condition">Condition</th>
                                <th class="price-col sortable" data-sort="current_price">Price</th>
                                <th class="change-col sortable" data-sort="value_change">Value Change</th>
                                <th class="date-col sortable" data-sort="date">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in collection_games %}
                            <tr>
                                <td>{{ "ðŸ”–" if game.is_wanted else "âœ“" }}</td>
                                <td title="{{ game.name }}">{{ game.name }}</td>
                                <td title="{{ game.console }}">{{ game.console }}</td>
                                <td title="{{ game.condition or '-' }}">{{ game.condition or '-' }}</td>
                                <td title="{{ "%.2f"|format(game.current_price) if game.current_price else '-' }}">{{ "%.2f"|format(game.current_price) if game.current_price else '-' }}</td>
                                <td>
                                    {% if not game.is_wanted and game.current_price and game.purchase_price %}
                                        {% set change = game.current_price - game.purchase_price %}
                                        {% set change_pct = (change / game.purchase_price) * 100 %}
                                        <span class="{{ 'text-success' if change >= 0 else 'text-danger' }}">
                                            {{ '%+.1f%%'|format(change_pct) }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td title="{{ game.date }}">{{ game.date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <!-- Server-side pagination -->
                    {% if not request.args.get('search') %}
                    <nav id="collectionPagination" aria-label="Collection pagination">
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing collection manager...');
            
            // Initialize arrays
            let allGames = [];
            let filteredGames = [];
            const ITEMS_PER_PAGE = 30;

            // Show loading state
            function showLoading() {
                const tbody = document.querySelector('#collectionTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading games...</td></tr>';
                }
            }

            // Load all games from API
            async function loadAllGames() {
                try {
                    showLoading();
                    console.log('Loading all games from API...');
                    const response = await fetch('/api/collection');
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    allGames = await response.json();
                    filteredGames = [...allGames];
                    console.log('Loaded games from API:', allGames.length);
                    renderGames(allGames, true, 1);
                } catch (error) {
                    console.error('Error loading games:', error);
                    const tbody = document.querySelector('#collectionTable tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading games. Please refresh the page to try again.</td></tr>';
                    }
                }
            }
            
            // Generate pagination HTML
            function generatePaginationHTML(currentPage, totalPages) {
                if (totalPages <= 1) return ''; // Don't show pagination if only one page
                
                let pages = new Set(); // Use Set to avoid duplicates
                
                // Add first 3 pages
                for (let i = 1; i <= 3 && i <= totalPages; i++) {
                    pages.add(i);
                }
                
                // Add 2 pages before and after current page
                for (let i = currentPage - 2; i <= currentPage + 2; i++) {
                    if (i > 0 && i <= totalPages) {
                        pages.add(i);
                    }
                }
                
                // Add last 3 pages
                for (let i = Math.max(totalPages - 2, 1); i <= totalPages; i++) {
                    pages.add(i);
                }
                
                // Convert to sorted array
                let pageArray = Array.from(pages).sort((a, b) => a - b);
                
                // Add ellipses where needed
                let finalPages = [];
                for (let i = 0; i < pageArray.length; i++) {
                    if (i > 0 && pageArray[i] > pageArray[i-1] + 1) {
                        finalPages.push('...');
                    }
                    finalPages.push(pageArray[i]);
                }
                
                return `
                    <ul class="pagination justify-content-center">
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                        </li>
                        ${finalPages.map(page => {
                            if (page === '...') {
                                return '<li class="page-item disabled"><span class="page-link">...</span></li>';
                            }
                            return `
                                <li class="page-item ${page === currentPage ? 'active' : ''}">
                                    <a class="page-link" href="#" data-page="${page}">${page}</a>
                                </li>
                            `;
                        }).join('')}
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                        </li>
                    </ul>
                `;
            }
            
            // Format currency
            function formatCurrency(value) {
                if (value === null || value === undefined) return '-';
                return '$' + parseFloat(value).toFixed(2);
            }
            
            // Format value change percentage
            function formatValueChange(current, purchase) {
                if (!current || !purchase) return '-';
                const change = ((current - purchase) / purchase) * 100;
                const formattedChange = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
                return change >= 0 ? 
                    `<span class="text-success">${formattedChange}</span>` :
                    `<span class="text-danger">${formattedChange}</span>`;
            }
            
            // Filter games
            function filterGames(games, searchTerm) {
                console.log('Filtering games with term:', searchTerm);
                if (!searchTerm) return games;
                searchTerm = searchTerm.toLowerCase();
                const filtered = games.filter(game => 
                    (game.name && game.name.toLowerCase().includes(searchTerm)) ||
                    (game.console && game.console.toLowerCase().includes(searchTerm))
                );
                console.log('Filtered games:', filtered.length);
                return filtered;
            }
            
            // Get current page of games
            function getCurrentPageGames(games, page) {
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                return games.slice(startIndex, startIndex + ITEMS_PER_PAGE);
            }
            
            // Render games with pagination
            function renderGames(games, preserveFilteredGames = false, page = 1) {
                console.log('Rendering games:', games.length);
                const tbody = document.querySelector('#collectionTable tbody');
                const pagination = document.getElementById('collectionPagination');
                if (!tbody) {
                    console.error('Collection table body not found!');
                    return;
                }

                // Store filtered games if this is a new filter operation
                if (!preserveFilteredGames) {
                    console.log('Updating filtered games array');
                    filteredGames = [...games];
                }

                // Calculate pagination
                const totalPages = Math.ceil(games.length / ITEMS_PER_PAGE);
                page = Math.max(1, Math.min(page, totalPages)); // Ensure page is valid
                
                // Get current page of games
                const pageGames = getCurrentPageGames(games, page);
                
                // Update pagination controls
                if (pagination) {
                    pagination.innerHTML = generatePaginationHTML(page, totalPages);
                    
                    // Add click handlers for pagination
                    pagination.querySelectorAll('.page-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const newPage = parseInt(e.target.dataset.page);
                            if (newPage && !isNaN(newPage) && newPage > 0 && newPage <= totalPages) {
                                renderGames(games, true, newPage);
                                // Scroll to top of table
                                document.querySelector('#collectionTable').scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                    });
                }
                
                // Show total results count
                const resultCount = document.getElementById('resultCount');
                if (resultCount) {
                    const startIndex = (page - 1) * ITEMS_PER_PAGE + 1;
                    const endIndex = Math.min(startIndex + ITEMS_PER_PAGE - 1, games.length);
                    resultCount.textContent = `Showing ${startIndex}-${endIndex} of ${games.length} results`;
                }

                // Render the games
                if (pageGames.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No games found</td></tr>';
                } else {
                    tbody.innerHTML = pageGames.map(game => {
                        const valueChange = !game.is_wanted ? formatValueChange(game.current_price, game.purchase_price) : '-';
                        return `
                            <tr>
                                <td>${game.is_wanted ? 'ðŸ”–' : 'âœ“'}</td>
                                <td title="${game.name}">${game.name}</td>
                                <td title="${game.console}">${game.console}</td>
                                <td title="${game.condition || '-'}">${game.condition || '-'}</td>
                                <td title="${formatCurrency(game.current_price)}">${formatCurrency(game.current_price)}</td>
                                <td title="${valueChange.replace(/<[^>]*>/g, '')}">${valueChange}</td>
                                <td title="${game.date || '-'}">${game.date || '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            // Sort games by a specific key
            function sortGames(games, sortKey, sortOrder) {
                return [...games].sort((a, b) => {
                    let aVal, bVal;
                    
                    // Handle special sorting cases
                    if (sortKey === 'status') {
                        aVal = a.is_wanted ? '1' : '0';
                        bVal = b.is_wanted ? '1' : '0';
                    } else if (sortKey === 'value_change' && !a.is_wanted && !b.is_wanted) {
                        if (!a.current_price || !a.purchase_price) return 1;
                        if (!b.current_price || !b.purchase_price) return -1;
                        aVal = ((a.current_price - a.purchase_price) / a.purchase_price) * 100;
                        bVal = ((b.current_price - b.purchase_price) / b.purchase_price) * 100;
                    } else if (sortKey === 'current_price') {
                        aVal = parseFloat(a[sortKey]) || 0;
                        bVal = parseFloat(b[sortKey]) || 0;
                    } else if (sortKey === 'date') {
                        aVal = new Date(a[sortKey]);
                        bVal = new Date(b[sortKey]);
                    } else {
                        aVal = a[sortKey];
                        bVal = b[sortKey];
                    }
                    
                    // Handle null/undefined values
                    if (aVal === null || aVal === undefined) return 1;
                    if (bVal === null || bVal === undefined) return -1;
                    
                    // Compare values
                    if (typeof aVal === 'string') {
                        return sortOrder === 'asc' ? 
                            aVal.localeCompare(bVal) : 
                            bVal.localeCompare(aVal);
                    }
                    return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }

            // Setup sorting functionality
            function setupSorting(tableId, defaultSort = 'name', defaultOrder = 'asc') {
                console.log('Setting up sorting');
                const table = document.getElementById(tableId);
                if (!table) {
                    console.error('Table not found:', tableId);
                    return;
                }
                
                let currentSort = defaultSort;
                let currentOrder = defaultOrder;
                
                const headers = table.querySelectorAll('th.sortable');
                headers.forEach(header => {
                    const sortKey = header.dataset.sort;
                    console.log('Setting up sort header:', sortKey);
                    
                    if (sortKey === defaultSort) {
                        header.classList.add(`sort-${defaultOrder}`);
                    }
                    
                    header.addEventListener('click', () => {
                        console.log('Sort header clicked:', sortKey);
                        // Update sort direction
                        if (sortKey === currentSort) {
                            currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort = sortKey;
                            currentOrder = 'asc';
                        }
                        
                        console.log('New sort:', currentSort, currentOrder);
                        
                        // Update header classes
                        headers.forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                        });
                        header.classList.add(`sort-${currentOrder}`);
                        
                        // Sort the games
                        console.log('Sorting games, count:', filteredGames.length);
                        const sortedGames = sortGames(filteredGames, currentSort, currentOrder);
                        renderGames(sortedGames, true, 1); // Reset to first page when sorting
                    });
                });
                
                return { currentSort, currentOrder };
            }

            // Setup table search functionality
            function setupTableSearch() {
                console.log('Setting up table search');
                const searchInput = document.getElementById('collectionSearch');
                if (!searchInput) {
                    console.error('Search input not found!');
                    return;
                }
                
                let debounceTimeout;
                searchInput.addEventListener('input', (e) => {
                    console.log('Search input changed:', e.target.value);
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        const searchTerm = e.target.value;
                        console.log('Filtering with term:', searchTerm);
                        const filtered = filterGames(allGames, searchTerm);
                        console.log('Found filtered games:', filtered.length);
                        renderGames(filtered, false, 1); // Reset to first page when filtering
                    }, 300);
                });
            }

            // Initialize
            console.log('Starting initialization...');
            await loadAllGames(); // Load all games first
            setupTableSearch();
            const { currentSort, currentOrder } = setupSorting('collectionTable', 'date', 'desc');
            // Apply initial sort
            const initialSortedGames = sortGames(filteredGames, currentSort, currentOrder);
            renderGames(initialSortedGames, true, 1);
            console.log('Initialization complete');
        });
    </script>

    <!-- Logout Button -->
<div class="container text-center pb-4">
    <a href="/logout" class="btn btn-outline-danger">Logout</a>
</div>
</body>
</html>
